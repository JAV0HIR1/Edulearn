<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment Submission</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind theme for custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af', // Deep Blue
                        'secondary-blue': '#bfdbfe', // Light Blue for backgrounds
                        'form-bg': '#f9fafb', // Very light gray for form area
                        'offer-red': '#dc2626', // Red for emphasis on savings
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #93c5fd; /* Light blue */
            border-radius: 4px;
        }
        /* Style for the active payment method tab */
        .tab-active {
            border-bottom: 3px solid #1e40af;
            color: #1e40af;
            font-weight: 600;
        }
        /* Style for selected plan card */
        .plan-selected {
            border-color: #1e40af;
            box-shadow: 0 0 0 3px #93c5fd;
            background-color: #eff6ff; /* Very light blue background */
        }
    </style>
</head>
<body class="bg-secondary-blue min-h-screen p-4 sm:p-8 font-sans flex items-center justify-center">

    <div id="payment-app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl overflow-hidden transform transition-all duration-300">

        <!-- Header: The educational/official look -->
        <header class="bg-primary-blue p-5 sm:p-6 text-white text-center rounded-t-xl">
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Subscription Plan Checkout</h1>
            <p class="text-sm opacity-90 mt-1">Select your desired plan and duration to proceed with secure payment.</p>
        </header>

        <main class="p-4 sm:p-8 md:p-10">

            <!-- 1. Plan & Duration Selection -->
            <section class="mb-8 border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-primary-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Choose Your Subscription
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Plan Cards -->
                    <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        
                        <!-- Pro Plan Card -->
                        <div id="plan-Pro" data-plan="Pro" class="plan-card p-5 border-2 border-gray-300 rounded-xl cursor-pointer transition duration-200 hover:border-primary-blue plan-selected">
                            <h3 class="text-xl font-bold text-primary-blue">Pro Plan</h3>
                            <p class="text-sm text-gray-600 mb-2">For one dedicated user.</p>
                            <p class="text-3xl font-extrabold text-green-600">
                                <span id="price-pro-display">$2.99</span>
                                <span class="text-base font-normal text-gray-500">/mo</span>
                            </p>
                            <p class="text-xs text-offer-red mt-1 font-semibold">
                                50% OFF first month! 
                                <span class="line-through text-gray-400">$4.99</span> 
                                <span class="font-normal text-gray-500">(then $4.99/mo)</span>
                            </p>
                        </div>
                        
                        <!-- Team Plan Card -->
                        <div id="plan-Team" data-plan="Team" class="plan-card p-5 border-2 border-gray-300 rounded-xl cursor-pointer transition duration-200 hover:border-primary-blue">
                            <h3 class="text-xl font-bold text-gray-800">Team Plan</h3>
                            <p class="text-sm text-gray-600 mb-2">For multiple users & collaboration.</p>
                            <p class="text-3xl font-extrabold text-green-600">
                                <span id="price-team-display">$9.99</span>
                                <span class="text-base font-normal text-gray-500">/mo</span>
                            </p>
                            <p class="text-xs text-offer-red mt-1 font-semibold">
                                50% OFF first month! 
                                <span class="line-through text-gray-400">$19.99</span> 
                                <span class="font-normal text-gray-500">(then $19.99/mo)</span>
                            </p>
                        </div>
                    </div>

                    <!-- Duration Selector and Total Summary -->
                    <div class="md:col-span-1 p-5 bg-form-bg rounded-xl border border-gray-200 space-y-4">
                        <div>
                            <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">Subscription Duration</label>
                            <select id="duration" name="duration" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-gray-800">
                                <option value="1">1 Month (Intro Offer)</option>
                                <option value="2">2 Months</option>
                                <option value="3">3 Months</option>
                                <option value="4">4 Months</option>
                                <option value="5">5 Months</option>
                                <option value="6">6 Months</option>
                                <option value="7">7 Months</option>
                                <option value="8">8 Months</option>
                                <option value="9">9 Months</option>
                                <option value="10">10 Months</option>
                                <option value="11">11 Months</option>
                                <option value="12">12 Months (Full Year)</option>
                            </select>
                        </div>
                        
                        <div class="pt-3 border-t">
                            <p class="text-sm font-medium text-gray-700">Total Due Today</p>
                            <p class="text-4xl font-extrabold text-primary-blue mt-1">
                                <span id="final-total">$2.99</span>
                                <span class="text-xl font-normal text-gray-500">USD</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1" id="total-breakdown">Includes 1 month at $2.99 offer price.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. Payment Method Selector (Tabs) -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-primary-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                    Select Payment Method
                </h2>

                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mb-6 space-x-2 sm:space-x-4 overflow-x-auto">
                    <button class="tab-button py-2 px-3 text-sm sm:text-base whitespace-nowrap text-gray-500 hover:text-primary-blue transition duration-150 tab-active" data-method="creditCard">
                        Credit Card
                    </button>
                    <button class="tab-button py-2 px-3 text-sm sm:text-base whitespace-nowrap text-gray-500 hover:text-primary-blue transition duration-150" data-method="paypal">
                        PayPal
                    </button>
                    <button class="tab-button py-2 px-3 text-sm sm:text-base whitespace-nowrap text-gray-500 hover:text-primary-blue transition duration-150" data-method="bankTransfer">
                        Bank Transfer
                    </button>
                </div>

                <!-- Method Content Areas -->
                <div id="method-content">
                    
                    <!-- Credit Card Content (Default Active) -->
                    <div id="creditCard" class="payment-content p-5 bg-form-bg rounded-lg shadow-inner">
                        <form id="creditCardForm">
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label for="cardNumber" class="block text-xs font-medium text-gray-600 mb-1">Card Number</label>
                                    <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" required maxlength="19"
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none">
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="col-span-2">
                                        <label for="expiryDate" class="block text-xs font-medium text-gray-600 mb-1">Expiry (MM/YY)</label>
                                        <input type="text" id="expiryDate" placeholder="01/25" required maxlength="5"
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none">
                                    </div>
                                    <div>
                                        <label for="cvc" class="block text-xs font-medium text-gray-600 mb-1">CVC</label>
                                        <input type="text" id="cvc" placeholder="123" required maxlength="4"
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label for="cardName" class="block text-xs font-medium text-gray-600 mb-1">Name on Card</label>
                                    <input type="text" id="cardName" placeholder="John Doe" required
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none">
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- PayPal Content -->
                    <div id="paypal" class="payment-content hidden p-5 bg-form-bg rounded-lg shadow-inner">
                        <div class="text-center py-4">
                            <!-- This text will be dynamically updated by JavaScript -->
                            <p class="text-gray-700 mb-3" id="paypal-text">You will be redirected to the secure PayPal gateway to complete your payment.</p>
                            <img src="https://www.paypalobjects.com/webstatic/mktg/logos/PP_Logo_W.svg" onerror="this.src='https://placehold.co/100x50/1e40af/ffffff?text=PayPal'" alt="PayPal Logo" class="h-6 w-auto mx-auto my-4 bg-primary-blue px-2 rounded-md">
                            <p class="text-sm text-gray-500">Ensure your browser's pop-up blocker is disabled.</p>
                        </div>
                    </div>

                    <!-- Bank Transfer Content -->
                    <div id="bankTransfer" class="payment-content hidden p-5 bg-form-bg rounded-lg shadow-inner">
                        <div class="space-y-3">
                            <p class="text-gray-700">Please initiate a transfer using the details below. **Your payment will be processed upon receipt.**</p>
                            <ul class="text-sm space-y-2 p-3 bg-white border border-gray-200 rounded-lg">
                                <li class="flex justify-between items-center text-gray-600">
                                    <span class="font-medium">Account Name:</span>
                                    <code class="text-primary-blue font-mono">EduTrust Funds</code>
                                </li>
                                <li class="flex justify-between items-center text-gray-600">
                                    <span class="font-medium">Account No.:</span>
                                    <code class="text-primary-blue font-mono">987654321</code>
                                </li>
                                <li class="flex justify-between items-center text-gray-600">
                                    <span class="font-medium">Reference Code:</span>
                                    <code id="referenceCode" class="text-primary-blue font-mono cursor-pointer hover:underline">Loading...</code>
                                </li>
                            </ul>
                            <div class="mt-4 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800">
                                IMPORTANT: Use the **Reference Code** as the payment description/memo to avoid delays.
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Action Button and Message Box -->
            <section>
                <button id="submitPayment" type="button"
                    class="w-full bg-green-600 text-white p-4 rounded-xl text-lg font-bold shadow-lg hover:bg-green-700 transition duration-200 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-green-300">
                    Process Payment of $2.99
                </button>

                <!-- Custom Message Box for alerts -->
                <div id="messageBox" class="hidden mt-4 p-3 rounded-lg text-center font-medium transition duration-300 ease-in-out"></div>
            </section>
        </main>
    </div>

    <script>
        // --- Core Application Logic ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // API key is handled by the Canvas environment

        // Define Plan Prices (Global Constants)
        const PRICE_PRO_ORIGINAL = 4.99;
        const PRICE_PRO_OFFER = 2.99;
        const PRICE_TEAM_ORIGINAL = 19.99;
        const PRICE_TEAM_OFFER = 9.99;

        // UI Elements
        const submitButton = document.getElementById('submitPayment');
        const methodContents = document.querySelectorAll('.payment-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        const messageBox = document.getElementById('messageBox');
        const referenceCodeElement = document.getElementById('referenceCode');
        const durationSelect = document.getElementById('duration');
        const planCards = document.querySelectorAll('.plan-card');
        const finalTotalDisplay = document.getElementById('final-total');
        const totalBreakdownElement = document.getElementById('total-breakdown');
        const paypalTextElement = document.getElementById('paypal-text');

        // State
        let currentMethod = 'creditCard';
        let selectedPlan = 'Pro'; // Default
        let selectedDuration = 1; // Default

        /**
         * Generates a unique, simulated reference code for the Bank Transfer.
         */
        function generateReferenceCode() {
            const randomString = Math.random().toString(36).substring(2, 8).toUpperCase();
            return `EDU-${randomString}-${new Date().getFullYear().toString().substring(2)}`;
        }

        /**
         * Calculates the total price based on the selected plan and duration,
         * applying the first-month discount.
         */
        function calculateTotal() {
            const duration = parseInt(selectedDuration, 10);
            let offerPrice, originalPrice, planName;

            if (selectedPlan === 'Pro') {
                offerPrice = PRICE_PRO_OFFER;
                originalPrice = PRICE_PRO_ORIGINAL;
                planName = "Pro";
            } else { // Team
                offerPrice = PRICE_TEAM_OFFER;
                originalPrice = PRICE_TEAM_ORIGINAL;
                planName = "Team";
            }

            let total;
            let breakdownText;

            if (duration === 1) {
                total = offerPrice;
                breakdownText = `Includes 1 month of ${planName} at $${offerPrice.toFixed(2)} offer price.`;
            } else {
                const remainingMonths = duration - 1;
                const remainingCost = remainingMonths * originalPrice;
                total = offerPrice + remainingCost;
                
                breakdownText = `Includes 1st month at $${offerPrice.toFixed(2)} (offer) and ${remainingMonths} months at $${originalPrice.toFixed(2)}.`;
            }

            return { total: total, breakdown: breakdownText };
        }

        /**
         * Updates all dynamic UI elements (Total, Button Text, PayPal Text).
         */
        function updateDisplay() {
            const calculation = calculateTotal();
            const amount = calculation.total.toFixed(2);
            
            // 1. Update Final Total Display
            finalTotalDisplay.textContent = `$${amount}`;
            totalBreakdownElement.textContent = calculation.breakdown;

            // 2. Update Submit Button Text
            // Note: selectMethod will handle the specific verb (Process/Continue/Generate)
            updateSubmitButtonText(amount); 
            
            // 3. Update PayPal Content
            paypalTextElement.innerHTML = `You will be redirected to the secure PayPal gateway to complete your payment of **$${amount}**.`;
        }

        /**
         * Updates the text on the submit button based on current method and amount.
         * @param {string} amount - The calculated total amount.
         */
        function updateSubmitButtonText(amount) {
             switch (currentMethod) {
                case 'creditCard':
                    submitButton.textContent = `Process Payment of $${amount}`;
                    break;
                case 'paypal':
                    submitButton.textContent = `Continue to PayPal`;
                    break;
                case 'bankTransfer':
                    submitButton.textContent = `Generate Reference & View Instructions`;
                    break;
            }
        }


        /**
         * Displays a custom message in the message box, simulating an alert/success/error.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = 'mt-4 p-3 rounded-lg text-center font-medium transition duration-300 ease-in-out';
            messageBox.classList.remove('hidden');

            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                default:
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                    break;
            }

            // Hide after 5 seconds
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * Handles the click on a payment method tab.
         * @param {string} method - The selected payment method key.
         */
        function selectMethod(method) {
            currentMethod = method;
            const amount = calculateTotal().total.toFixed(2);

            // Update tab styles
            tabButtons.forEach(btn => {
                btn.classList.remove('tab-active');
                if (btn.dataset.method === method) {
                    btn.classList.add('tab-active');
                }
            });

            // Update content visibility
            methodContents.forEach(content => {
                if (content.id === method) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });

            // Update button text and style based on method
            submitButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-300', 'bg-yellow-600', 'hover:bg-yellow-700', 'focus:ring-yellow-300', 'bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-300');

            switch (method) {
                case 'creditCard':
                    submitButton.textContent = `Process Payment of $${amount}`;
                    submitButton.classList.add('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-300');
                    break;
                case 'paypal':
                    submitButton.textContent = `Continue to PayPal`;
                    submitButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700', 'focus:ring-yellow-300');
                    break;
                case 'bankTransfer':
                    submitButton.textContent = `Generate Reference & View Instructions`;
                    submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-300');
                    break;
            }
        }

        /**
         * Handles the selection of a new plan (Pro or Team).
         * @param {string} plan - 'Pro' or 'Team'.
         */
        function selectPlan(plan) {
            selectedPlan = plan;

            // Update card styles
            planCards.forEach(card => {
                card.classList.remove('plan-selected');
                card.classList.remove('bg-eff6ff');
                // Reset colors to default
                const h3 = card.querySelector('h3');
                if (h3) h3.classList.remove('text-primary-blue');
                
                if (card.dataset.plan === plan) {
                    card.classList.add('plan-selected');
                    const selectedH3 = card.querySelector('h3');
                    if (selectedH3) selectedH3.classList.add('text-primary-blue');
                } else {
                    const unselectedH3 = card.querySelector('h3');
                    if (unselectedH3) unselectedH3.classList.add('text-gray-800');
                }
            });

            updateDisplay();
        }

        /**
         * Simulates the payment submission process.
         */
        async function handleSubmit() {
            const amount = calculateTotal().total.toFixed(2);
            showMessage("Processing plan subscription...", 'info');
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Logic based on current method
            switch (currentMethod) {
                case 'creditCard':
                    // Basic client-side validation for CC
                    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                    if (cardNumber.length !== 16 || !/^\d+$/.test(cardNumber)) {
                        showMessage("Credit Card: Invalid card number format. Must be 16 digits.", 'error');
                        return;
                    }
                    showMessage(`Success! ${selectedPlan} Plan subscribed for ${selectedDuration} months. Total charged: $${amount}.`, 'success');
                    break;

                case 'paypal':
                    showMessage(`Redirecting to PayPal for $${amount}. This is a simulation.`, 'info');
                    break;
                
                case 'bankTransfer':
                    const code = referenceCodeElement.textContent;
                    showMessage(`Transfer instructions generated! Use code ${code} for $${amount}.`, 'success');
                    // Reset button text to reflect completion
                    updateSubmitButtonText(amount); // Re-run to update text if needed
                    break;
            }
        }

        /**
         * Event Listeners and Initialization
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial reference code
            referenceCodeElement.textContent = generateReferenceCode();

            // Initial display update
            updateDisplay();

            // Event listeners for plan cards
            planCards.forEach(card => {
                card.addEventListener('click', () => selectPlan(card.dataset.plan));
            });

            // Event listener for duration change
            durationSelect.addEventListener('change', (e) => {
                selectedDuration = parseInt(e.target.value, 10);
                updateDisplay();
            });

            // Event listener for payment method tabs
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => selectMethod(btn.dataset.method));
            });

            // Event listener for main button click
            submitButton.addEventListener('click', handleSubmit);

            // Copy reference code on click
            referenceCodeElement.addEventListener('click', () => {
                const textToCopy = referenceCodeElement.textContent;
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showMessage(`Reference code ${textToCopy} copied to clipboard!`, 'info');
                } catch (err) {
                    console.error('Oops, unable to copy', err);
                    showMessage('Failed to copy reference code. Please copy manually.', 'error');
                }
                document.body.removeChild(textArea);
            });
        });
    </script>
</body>
</html>
